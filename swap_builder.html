<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swap Builder - Polish Bid 2026-27</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            padding: 15px 20px;
            border-bottom: 2px solid #0f3460;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { color: #e94560; font-size: 1.3em; }
        .header p { color: #888; font-size: 12px; }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Left Panel - Line Selection */
        .selection-panel {
            width: 320px;
            background: #16213e;
            border-right: 2px solid #0f3460;
            padding: 15px;
            overflow-y: auto;
        }
        
        .panel-section {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .panel-section h3 {
            color: #4ecca3;
            font-size: 14px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .line-select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            background: #16213e;
            color: #fff;
            border: 1px solid #4ecca3;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .partner-list {
            max-height: 200px;
            overflow-y: auto;
        }
        
        .partner-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: #16213e;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .partner-item .line-info {
            color: #4ecca3;
            font-weight: bold;
        }
        
        .partner-item .remove-btn {
            background: #e94560;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 3px 8px;
            cursor: pointer;
            font-size: 11px;
        }
        
        .add-partner-row {
            display: flex;
            gap: 10px;
        }
        
        .add-partner-row select {
            flex: 1;
        }
        
        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-box {
            background: #16213e;
            padding: 12px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-box .value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-box .label {
            font-size: 10px;
            color: #888;
            margin-top: 3px;
        }
        
        .stat-box.balanced .value { color: #4ecca3; }
        .stat-box.over .value { color: #e94560; }
        .stat-box.under .value { color: #f0a500; }
        
        .balance-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .balance-indicator.balanced {
            background: rgba(78, 204, 163, 0.2);
            color: #4ecca3;
        }
        
        .balance-indicator.over {
            background: rgba(233, 69, 96, 0.2);
            color: #e94560;
        }
        
        .balance-indicator.under {
            background: rgba(240, 165, 0, 0.2);
            color: #f0a500;
        }
        
        /* Right Panel - Calendar View */
        .calendar-panel {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-header h2 {
            color: #4ecca3;
            font-size: 16px;
        }
        
        .view-toggle {
            display: flex;
            gap: 5px;
        }
        
        .view-toggle .btn {
            padding: 6px 12px;
            background: #0f3460;
            color: #888;
        }
        
        .view-toggle .btn.active {
            background: #4ecca3;
            color: #1a1a2e;
        }
        
        /* Month Grid */
        .months-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }
        
        .month-block {
            background: #0f3460;
            border-radius: 8px;
            padding: 10px;
        }
        
        .month-title {
            color: #e94560;
            font-weight: bold;
            font-size: 12px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            margin-bottom: 5px;
        }
        
        .month-header span {
            text-align: center;
            font-size: 9px;
            color: #888;
        }
        
        .month-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .day-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            font-size: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .day-cell:hover {
            transform: scale(1.1);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .day-cell.empty {
            background: transparent;
            cursor: default;
        }
        
        .day-cell.empty:hover {
            transform: none;
            box-shadow: none;
        }
        
        .day-cell .day-num {
            font-weight: bold;
            font-size: 9px;
        }
        
        .day-cell .shift-code {
            font-size: 7px;
            margin-top: 1px;
        }
        
        .day-cell.work-day {
            background: #FFC000;
            color: #000;
        }
        
        .day-cell.off-day {
            background: #FFFFFF;
            color: #000;
        }
        
        .day-cell.swapped {
            border: 2px solid #9b59b6;
            box-shadow: 0 0 5px #9b59b6;
        }
        
        .day-cell.swapped-in {
            border: 2px solid #4ecca3;
        }
        
        .day-cell.swapped-out {
            border: 2px solid #e94560;
        }
        
        .day-cell.holiday {
            border: 2px solid #e94560;
        }
        
        /* Swap List View */
        .swap-list {
            background: #0f3460;
            border-radius: 8px;
            padding: 15px;
        }
        
        .swap-list h3 {
            color: #4ecca3;
            margin-bottom: 15px;
        }
        
        .swap-item {
            display: grid;
            grid-template-columns: 100px 1fr 80px 80px 60px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            background: #16213e;
            border-radius: 5px;
            margin-bottom: 8px;
        }
        
        .swap-item .date {
            color: #4ecca3;
            font-weight: bold;
        }
        
        .swap-item .description {
            color: #ccc;
            font-size: 12px;
        }
        
        .swap-item .from-line {
            color: #e94560;
        }
        
        .swap-item .to-line {
            color: #4ecca3;
        }
        
        .swap-item .remove-btn {
            background: #e94560;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 11px;
        }
        
        /* Swap Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal h3 {
            color: #e94560;
            margin-bottom: 15px;
        }
        
        .modal-close {
            float: right;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 15px;
            cursor: pointer;
        }
        
        .swap-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #0f3460;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .swap-option:hover {
            background: #1a3a5c;
            transform: translateX(5px);
        }
        
        .swap-option .partner-info {
            display: flex;
            flex-direction: column;
        }
        
        .swap-option .line-name {
            color: #4ecca3;
            font-weight: bold;
        }
        
        .swap-option .shift-info {
            color: #888;
            font-size: 11px;
        }
        
        .swap-option .action-label {
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
        }
        
        .swap-option.take .action-label {
            background: #4ecca3;
            color: #1a1a2e;
        }
        
        .swap-option.give .action-label {
            background: #e94560;
            color: white;
        }
        
        /* Partner Balances */
        .partner-balances {
            margin-top: 15px;
        }
        
        .partner-balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #16213e;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        .partner-balance-item .line-name {
            color: #4ecca3;
            font-weight: bold;
        }
        
        .partner-balance-item .balance {
            font-weight: bold;
        }
        
        .partner-balance-item .balance.balanced { color: #4ecca3; }
        .partner-balance-item .balance.over { color: #e94560; }
        .partner-balance-item .balance.under { color: #f0a500; }
        
        /* Legend */
        .legend {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding: 10px;
            background: #0f3460;
            border-radius: 5px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #888;
        }
        
        .legend-item .swatch {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        /* Export Section */
        .export-section {
            margin-top: 15px;
            padding: 15px;
            background: #0f3460;
            border-radius: 8px;
        }
        
        .export-section h3 {
            color: #4ecca3;
            margin-bottom: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        /* No line selected state */
        .no-line-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
        }
        
        .no-line-message .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 1200px) {
            .months-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .main-container {
                flex-direction: column;
            }
            .selection-panel {
                width: 100%;
                border-right: none;
                border-bottom: 2px solid #0f3460;
            }
            .months-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h1>üîÑ Swap Builder - Polish Bid 2026-27</h1>
            <p>Build your custom schedule by swapping shifts with partners</p>
        </div>
        <div>
            <a href="index.html" class="btn" style="background:#4ecca3; color:#1a1a2e; text-decoration:none;">‚Üê Back to Bid</a>
        </div>
    </div>
    
    <div class="main-container">
        <!-- Left Panel -->
        <div class="selection-panel">
            <!-- Your Line Selection -->
            <div class="panel-section">
                <h3>üìã Your Line</h3>
                <select id="myLineSelect" class="line-select" onchange="selectMyLine()">
                    <option value="">-- Select Your Line --</option>
                </select>
                <div id="myLinePattern" style="display:none;">
                    <div id="myLinePatternDisplay" style="display:flex; gap:2px; flex-wrap:wrap;"></div>
                </div>
            </div>
            
            <!-- Swap Partners -->
            <div class="panel-section">
                <h3>üë• Swap Partners</h3>
                <div class="add-partner-row">
                    <select id="partnerSelect" class="line-select" style="margin-bottom:0;">
                        <option value="">-- Add Partner --</option>
                    </select>
                    <button class="btn" style="background:#4ecca3; color:#1a1a2e;" onclick="addPartner()">+ Add</button>
                </div>
                <div id="partnerList" class="partner-list" style="margin-top:10px;"></div>
            </div>
            
            <!-- Your Stats -->
            <div class="panel-section">
                <h3>üìä Your Work Days</h3>
                <div class="stats-grid">
                    <div class="stat-box" id="baseWorkDays">
                        <div class="value">--</div>
                        <div class="label">Base Days</div>
                    </div>
                    <div class="stat-box" id="currentWorkDays">
                        <div class="value">--</div>
                        <div class="label">After Swaps</div>
                    </div>
                    <div class="stat-box" id="swapsIn">
                        <div class="value">0</div>
                        <div class="label">Shifts Taken</div>
                    </div>
                    <div class="stat-box" id="swapsOut">
                        <div class="value">0</div>
                        <div class="label">Shifts Given</div>
                    </div>
                </div>
                <div id="balanceIndicator" class="balance-indicator balanced" style="display:none;">
                    ‚úì BALANCED (152 days)
                </div>
            </div>
            
            <!-- Partner Balances -->
            <div class="panel-section">
                <h3>‚öñÔ∏è Partner Balances</h3>
                <div id="partnerBalances" class="partner-balances">
                    <p style="color:#888; font-size:12px;">Add partners to see their balances</p>
                </div>
            </div>
            
            <!-- Export -->
            <div class="panel-section">
                <h3>üì§ Export</h3>
                <div class="export-buttons">
                    <button class="btn" style="background:#4ecca3; color:#1a1a2e;" onclick="exportSwappedICS()">üì• Export ICS</button>
                    <button class="btn" style="background:#2563eb; color:white;" onclick="printSwapSummary()">üìÑ Print Summary</button>
                    <button class="btn" style="background:#9b59b6; color:white;" onclick="saveSwaps()">üíæ Save Swaps</button>
                    <button class="btn" style="background:#e94560; color:white;" onclick="clearAllSwaps()">üóëÔ∏è Clear All</button>
                </div>
            </div>
        </div>
        
        <!-- Right Panel - Calendar -->
        <div class="calendar-panel">
            <div id="noLineMessage" class="no-line-message">
                <div class="icon">üìÖ</div>
                <h3>Select Your Line to Begin</h3>
                <p>Choose your line from the left panel to start building swaps</p>
            </div>
            
            <div id="calendarContainer" style="display:none;">
                <div class="calendar-header">
                    <h2 id="calendarTitle">Your Schedule</h2>
                    <div class="view-toggle">
                        <button class="btn active" id="calViewBtn" onclick="setView('calendar')">üìÖ My Calendar</button>
                        <button class="btn" id="allLinesViewBtn" onclick="setView('allLines')">üë• All Lines</button>
                        <button class="btn" id="listViewBtn" onclick="setView('list')">üìã Swap List</button>
                    </div>
                </div>
                
                <div class="legend">
                    <div class="legend-item">
                        <div class="swatch" style="background:#FFC000;"></div>
                        <span>Work Day</span>
                    </div>
                    <div class="legend-item">
                        <div class="swatch" style="background:#FFFFFF; border:1px solid #888;"></div>
                        <span>Off Day</span>
                    </div>
                    <div class="legend-item">
                        <div class="swatch" style="background:#FFC000; border:2px solid #4ecca3;"></div>
                        <span>Shift Taken</span>
                    </div>
                    <div class="legend-item">
                        <div class="swatch" style="background:#FFFFFF; border:2px solid #e94560;"></div>
                        <span>Shift Given</span>
                    </div>
                    <div class="legend-item">
                        <div class="swatch" style="background:#FFC000; border:2px solid #e94560;"></div>
                        <span>Holiday</span>
                    </div>
                </div>
                
                <div id="calendarView" class="months-grid" style="margin-top:15px;"></div>
                
                <!-- All Lines Comparison View -->
                <div id="allLinesView" style="display:none; margin-top:15px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <div style="display:flex; gap:10px; align-items:center;">
                            <button class="btn" onclick="prevMonth()" style="background:#0f3460; color:#4ecca3;">‚óÄ Prev</button>
                            <h3 id="allLinesMonthTitle" style="color:#e94560; margin:0; min-width:150px; text-align:center;">April 2026</h3>
                            <button class="btn" onclick="nextMonth()" style="background:#0f3460; color:#4ecca3;">Next ‚ñ∂</button>
                        </div>
                        <div style="color:#888; font-size:12px;">Click any day to swap</div>
                    </div>
                    <div id="allLinesContent" style="background:#0f3460; border-radius:8px; padding:15px; overflow-x:auto;"></div>
                </div>
                
                <div id="listView" class="swap-list" style="display:none; margin-top:15px;">
                    <h3>Swap List</h3>
                    <div id="swapListContent">
                        <p style="color:#888;">No swaps yet. Click on days in the calendar to create swaps.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Swap Modal -->
    <div class="modal-overlay" id="swapModal" onclick="hideSwapModal()">
        <div class="modal" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="hideSwapModal()">Close</button>
            <h3 id="swapModalTitle">Swap Options</h3>
            <p id="swapModalDate" style="color:#888; margin-bottom:15px;"></p>
            
            <div id="swapModalContent"></div>
        </div>
    </div>
    
    <!-- Load data files -->
    <script src="may_overrides.js"></script>
    <script src="annual_bid_data.js"></script>
    <script src="calendar_generator.js"></script>
    
    <script>
        // State
        var myLine = null;
        var partners = [];
        var swaps = []; // { date: '2026-4-15', fromLine: '1', toLine: '5', shift: 'E05A' }
        var currentView = 'calendar';
        var currentMonthIndex = 0; // 0 = April 2026, 11 = March 2027
        
        var MONTHS = [
            { name: 'April 2026', year: 2026, month: 3 },
            { name: 'May 2026', year: 2026, month: 4 },
            { name: 'June 2026', year: 2026, month: 5 },
            { name: 'July 2026', year: 2026, month: 6 },
            { name: 'August 2026', year: 2026, month: 7 },
            { name: 'September 2026', year: 2026, month: 8 },
            { name: 'October 2026', year: 2026, month: 9 },
            { name: 'November 2026', year: 2026, month: 10 },
            { name: 'December 2026', year: 2026, month: 11 },
            { name: 'January 2027', year: 2027, month: 0 },
            { name: 'February 2027', year: 2027, month: 1 },
            { name: 'March 2027', year: 2027, month: 2 }
        ];
        
        var HOLIDAYS = {
            '2026-4-5': 'EAST1',
            '2026-5-10': 'MOM',
            '2026-5-25': 'MEMOR',
            '2026-6-21': 'DAD',
            '2026-7-4': '4TH',
            '2026-9-7': 'LABOR',
            '2026-11-26': 'THX',
            '2026-12-25': 'XMAS',
            '2027-1-1': 'NYD',
            '2027-2-14': 'SUPER',
            '2027-3-17': 'STPAT',
            '2027-3-28': 'EAST2'
        };
        
        // Helper function to get shift start hour from shift code
        function getShiftStartHour(shiftCode) {
            if (!shiftCode || shiftCode === '--') return null;
            var hour = parseInt(shiftCode.substring(1, 3), 10);
            return isNaN(hour) ? 6 : hour;
        }
        
        // Helper function to get shift end hour (12 hour shifts)
        function getShiftEndHour(shiftCode) {
            var start = getShiftStartHour(shiftCode);
            if (start === null) return null;
            return (start + 12) % 24;
        }
        
        // Check if a shift is an overnight shift (crosses midnight)
        function isOvernightShift(shiftCode) {
            var start = getShiftStartHour(shiftCode);
            var end = getShiftEndHour(shiftCode);
            if (start === null || end === null) return false;
            // Overnight if start > end (e.g., 18:00 to 02:00) or end is 0 (midnight)
            return start > end || end === 0;
        }
        
        // Get adjacent date string
        function getAdjacentDate(dateKey, offset) {
            var parts = dateKey.split('-');
            var date = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            date.setDate(date.getDate() + offset);
            return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
        }
        
        // Check 8-hour rest rule for a line taking a new shift on a specific date
        function check8HourRest(lineNbr, dateKey, newShiftCode) {
            var newStart = getShiftStartHour(newShiftCode);
            if (newStart === null) return { valid: true };
            
            var newEnd = getShiftEndHour(newShiftCode);
            var newIsOvernight = isOvernightShift(newShiftCode);
            
            // =====================================================
            // CHECK 1: Previous day's shift -> New shift
            // =====================================================
            var prevDateKey = getAdjacentDate(dateKey, -1);
            var prevShift = getEffectiveShiftForLine(lineNbr, prevDateKey);
            if (prevShift && prevShift !== '--') {
                var prevStart = getShiftStartHour(prevShift);
                var prevEnd = getShiftEndHour(prevShift);
                var prevIsOvernight = isOvernightShift(prevShift);
                
                var restHours;
                
                if (prevIsOvernight) {
                    // Previous shift ends early morning on the CURRENT day (the day we're adding the new shift)
                    // Example: M18 (18:00-02:00) on Day 1 ends at 02:00 on Day 2
                    // If new shift starts at 06:00 on Day 2: rest = 06:00 - 02:00 = 4 hours
                    // If new shift starts at 12:00 on Day 2: rest = 12:00 - 02:00 = 10 hours
                    if (newStart >= prevEnd) {
                        restHours = newStart - prevEnd;
                    } else {
                        // New shift starts before previous overnight shift ends - impossible/overlap
                        restHours = 0;
                    }
                } else {
                    // Previous shift ends on the PREVIOUS day (normal day shift)
                    // Example: E06 (06:00-14:00) on Day 1 ends at 14:00 on Day 1
                    // New shift on Day 2 at 06:00: rest = (24-14) + 6 = 16 hours
                    restHours = (24 - prevEnd) + newStart;
                }
                
                if (restHours < 8) {
                    return { 
                        valid: false, 
                        reason: 'Only ' + restHours + 'h rest after previous shift (' + prevShift + ' ends at ' + String(prevEnd).padStart(2,'0') + ':00' + (prevIsOvernight ? ' next morning' : '') + ')'
                    };
                }
            }
            
            // =====================================================
            // CHECK 2: New shift -> Next day's shift
            // =====================================================
            var nextDateKey = getAdjacentDate(dateKey, 1);
            var nextShift = getEffectiveShiftForLine(lineNbr, nextDateKey);
            if (nextShift && nextShift !== '--') {
                var nextStart = getShiftStartHour(nextShift);
                
                var restHours;
                
                if (newIsOvernight) {
                    // New shift ends early morning on the NEXT day
                    // Example: M18 (18:00-02:00) on Day 1 ends at 02:00 on Day 2
                    // If next shift starts at 06:00 on Day 2: rest = 06:00 - 02:00 = 4 hours
                    if (nextStart >= newEnd) {
                        restHours = nextStart - newEnd;
                    } else {
                        // Next shift starts before new overnight shift ends - impossible/overlap
                        restHours = 0;
                    }
                } else {
                    // New shift ends on the CURRENT day (normal day shift)
                    // Example: E06 (06:00-14:00) ends at 14:00
                    // Next day shift at 06:00: rest = (24-14) + 6 = 16 hours
                    restHours = (24 - newEnd) + nextStart;
                }
                
                if (restHours < 8) {
                    return { 
                        valid: false, 
                        reason: 'Only ' + restHours + 'h rest before next shift (' + nextShift + ' starts at ' + String(nextStart).padStart(2,'0') + ':00)'
                    };
                }
            }
            
            return { valid: true };
        }
        
        // Get effective shift for any line (considering swaps)
        function getEffectiveShiftForLine(lineNbr, dateKey) {
            var calendar = ALL_LINES_CALENDAR[lineNbr];
            if (!calendar || !calendar.days[dateKey]) return '--';
            
            var baseShift = calendar.days[dateKey].s;
            
            // Check if this day has been swapped for this line
            for (var i = 0; i < swaps.length; i++) {
                var swap = swaps[i];
                if (swap.date === dateKey) {
                    if (swap.fromLine === lineNbr) {
                        // This line gave away their shift
                        return '--';
                    } else if (swap.toLine === lineNbr) {
                        // This line took a shift
                        return swap.shift;
                    }
                }
            }
            
            return baseShift;
        }
        
        // Check if partner already has a swap on this date
        function partnerHasSwapOnDate(partnerLine, dateKey) {
            for (var i = 0; i < swaps.length; i++) {
                var swap = swaps[i];
                if (swap.date === dateKey && (swap.fromLine === partnerLine || swap.toLine === partnerLine)) {
                    return true;
                }
            }
            return false;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            populateLineSelects();
            loadSavedSwaps();
        });
        
        function populateLineSelects() {
            var mySelect = document.getElementById('myLineSelect');
            var partnerSelect = document.getElementById('partnerSelect');
            
            ANNUAL_BID.forEach(function(line) {
                var opt1 = document.createElement('option');
                opt1.value = line.lineNbr;
                opt1.textContent = 'Line ' + line.lineNbr + ' (' + line.lineDesc + ')';
                mySelect.appendChild(opt1);
                
                var opt2 = document.createElement('option');
                opt2.value = line.lineNbr;
                opt2.textContent = 'Line ' + line.lineNbr + ' (' + line.lineDesc + ')';
                partnerSelect.appendChild(opt2);
            });
        }
        
        function selectMyLine() {
            var select = document.getElementById('myLineSelect');
            myLine = select.value;
            
            if (myLine) {
                document.getElementById('noLineMessage').style.display = 'none';
                document.getElementById('calendarContainer').style.display = 'block';
                document.getElementById('myLinePattern').style.display = 'block';
                
                // Show pattern
                var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === myLine; });
                if (lineData) {
                    var patternHtml = '';
                    for (var i = 0; i < 12; i++) {
                        var bg = lineData.days[i] === '--' ? '#FFFFFF' : '#FFC000';
                        var color = '#000';
                        patternHtml += '<div style="width:28px; height:22px; background:' + bg + '; color:' + color + '; display:flex; align-items:center; justify-content:center; border-radius:3px; font-size:8px; font-weight:bold;">' + lineData.days[i] + '</div>';
                    }
                    document.getElementById('myLinePatternDisplay').innerHTML = patternHtml;
                    document.getElementById('calendarTitle').textContent = 'Line ' + myLine + ' (' + lineData.lineDesc + ')';
                }
                
                renderCalendar();
                updateStats();
            } else {
                document.getElementById('noLineMessage').style.display = 'flex';
                document.getElementById('calendarContainer').style.display = 'none';
                document.getElementById('myLinePattern').style.display = 'none';
            }
        }
        
        function addPartner() {
            var select = document.getElementById('partnerSelect');
            var lineNbr = select.value;
            
            if (!lineNbr) {
                alert('Please select a line to add as partner');
                return;
            }
            
            if (lineNbr === myLine) {
                alert('Cannot add your own line as a partner');
                return;
            }
            
            if (partners.indexOf(lineNbr) !== -1) {
                alert('This line is already a partner');
                return;
            }
            
            partners.push(lineNbr);
            select.value = '';
            renderPartnerList();
            updatePartnerBalances();
            if (currentView === 'allLines') renderAllLinesView();
            autoSave();
        }
        
        function removePartner(lineNbr) {
            var idx = partners.indexOf(lineNbr);
            if (idx !== -1) {
                partners.splice(idx, 1);
            }
            
            // Remove any swaps with this partner
            swaps = swaps.filter(function(s) {
                return s.fromLine !== lineNbr && s.toLine !== lineNbr;
            });
            
            renderPartnerList();
            renderCalendar();
            if (currentView === 'allLines') renderAllLinesView();
            updateStats();
            updatePartnerBalances();
            autoSave();
        }
        
        function renderPartnerList() {
            var container = document.getElementById('partnerList');
            
            if (partners.length === 0) {
                container.innerHTML = '<p style="color:#888; font-size:12px;">No partners added yet</p>';
                return;
            }
            
            var html = '';
            partners.forEach(function(lineNbr) {
                var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === lineNbr; });
                var desc = lineData ? lineData.lineDesc : '';
                
                html += '<div class="partner-item">' +
                    '<span class="line-info">Line ' + lineNbr + ' (' + desc + ')</span>' +
                    '<button class="remove-btn" onclick="removePartner(\'' + lineNbr + '\')">‚úï</button>' +
                '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function renderCalendar() {
            if (!myLine) return;
            
            var container = document.getElementById('calendarView');
            var calendar = ALL_LINES_CALENDAR[myLine];
            if (!calendar) return;
            
            var months = [
                { name: 'April 2026', year: 2026, month: 3 },
                { name: 'May 2026', year: 2026, month: 4 },
                { name: 'June 2026', year: 2026, month: 5 },
                { name: 'July 2026', year: 2026, month: 6 },
                { name: 'August 2026', year: 2026, month: 7 },
                { name: 'September 2026', year: 2026, month: 8 },
                { name: 'October 2026', year: 2026, month: 9 },
                { name: 'November 2026', year: 2026, month: 10 },
                { name: 'December 2026', year: 2026, month: 11 },
                { name: 'January 2027', year: 2027, month: 0 },
                { name: 'February 2027', year: 2027, month: 1 },
                { name: 'March 2027', year: 2027, month: 2 }
            ];
            
            var html = '';
            
            months.forEach(function(m) {
                html += '<div class="month-block">';
                html += '<div class="month-title">' + m.name + '</div>';
                html += '<div class="month-header"><span>Su</span><span>Mo</span><span>Tu</span><span>We</span><span>Th</span><span>Fr</span><span>Sa</span></div>';
                html += '<div class="month-days">';
                
                var firstDay = new Date(m.year, m.month, 1);
                var lastDay = new Date(m.year, m.month + 1, 0);
                var startDayOfWeek = firstDay.getDay();
                
                // Empty cells for days before first of month
                for (var i = 0; i < startDayOfWeek; i++) {
                    html += '<div class="day-cell empty"></div>';
                }
                
                // Days of the month
                for (var day = 1; day <= lastDay.getDate(); day++) {
                    var dateKey = m.year + '-' + (m.month + 1) + '-' + day;
                    var effectiveShift = getEffectiveShift(myLine, dateKey);
                    var isWorkDay = effectiveShift !== '--';
                    var isHoliday = HOLIDAYS[dateKey];
                    var swapInfo = getSwapInfo(dateKey);
                    
                    var cellClass = 'day-cell ' + (isWorkDay ? 'work-day' : 'off-day');
                    if (isHoliday) cellClass += ' holiday';
                    if (swapInfo) {
                        if (swapInfo.type === 'in') cellClass += ' swapped-in';
                        else if (swapInfo.type === 'out') cellClass += ' swapped-out';
                    }
                    
                    html += '<div class="' + cellClass + '" onclick="showSwapOptions(\'' + dateKey + '\')">';
                    html += '<span class="day-num">' + day + '</span>';
                    html += '<span class="shift-code">' + (effectiveShift === '--' ? 'OFF' : effectiveShift.substring(0, 3)) + '</span>';
                    html += '</div>';
                }
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
            renderSwapList();
        }
        
        function getEffectiveShift(lineNbr, dateKey) {
            var calendar = ALL_LINES_CALENDAR[lineNbr];
            if (!calendar) return '--';
            
            var baseShift = calendar.days[dateKey] ? calendar.days[dateKey].s : '--';
            
            // Check if this day has been swapped
            if (lineNbr === myLine) {
                // For my line, check if I gave away this shift or took one
                for (var i = 0; i < swaps.length; i++) {
                    var swap = swaps[i];
                    if (swap.date === dateKey) {
                        if (swap.fromLine === myLine) {
                            // I gave away my shift, so I'm off now
                            return '--';
                        } else if (swap.toLine === myLine) {
                            // I took someone's shift
                            return swap.shift;
                        }
                    }
                }
            }
            
            return baseShift;
        }
        
        function getSwapInfo(dateKey) {
            for (var i = 0; i < swaps.length; i++) {
                var swap = swaps[i];
                if (swap.date === dateKey) {
                    if (swap.toLine === myLine) {
                        return { type: 'in', swap: swap };
                    } else if (swap.fromLine === myLine) {
                        return { type: 'out', swap: swap };
                    }
                }
            }
            return null;
        }
        
        function showSwapOptions(dateKey) {
            if (partners.length === 0) {
                alert('Please add at least one swap partner first');
                return;
            }
            
            var myCalendar = ALL_LINES_CALENDAR[myLine];
            var myShift = myCalendar.days[dateKey] ? myCalendar.days[dateKey].s : '--';
            var myIsWorking = myShift !== '--';
            
            // Check if already swapped
            var existingSwap = getSwapInfo(dateKey);
            
            var date = new Date(dateKey.replace(/-/g, '/'));
            var dateStr = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            document.getElementById('swapModalTitle').textContent = existingSwap ? 'Remove Swap' : 'Swap Options';
            document.getElementById('swapModalDate').innerHTML = '<strong>' + dateStr + '</strong><br>Your shift: ' + (myIsWorking ? myShift : 'OFF');
            
            var content = '';
            
            if (existingSwap) {
                // Show option to remove the swap
                var otherLine = existingSwap.type === 'in' ? existingSwap.swap.fromLine : existingSwap.swap.toLine;
                var otherLineData = ANNUAL_BID.find(function(l) { return l.lineNbr === otherLine; });
                
                content += '<div class="swap-option" onclick="removeSwap(\'' + dateKey + '\')" style="border:2px solid #e94560;">';
                content += '<div class="partner-info">';
                content += '<span class="line-name">Remove swap with Line ' + otherLine + '</span>';
                content += '<span class="shift-info">' + (existingSwap.type === 'in' ? 'You took ' + existingSwap.swap.shift : 'You gave ' + existingSwap.swap.shift) + '</span>';
                content += '</div>';
                content += '<span class="action-label" style="background:#e94560; color:white;">Remove</span>';
                content += '</div>';
            } else {
                // Show swap options with partners
                partners.forEach(function(partnerLine) {
                    var partnerCalendar = ALL_LINES_CALENDAR[partnerLine];
                    if (!partnerCalendar) return;
                    
                    var partnerShift = partnerCalendar.days[dateKey] ? partnerCalendar.days[dateKey].s : '--';
                    var partnerIsWorking = partnerShift !== '--';
                    var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === partnerLine; });
                    
                    // Check if partner already has a swap on this date
                    var partnerBusy = partnerHasSwapOnDate(partnerLine, dateKey);
                    
                    // Can only swap if one is working and one is off
                    if (myIsWorking && !partnerIsWorking) {
                        // I can give my shift to partner - check 8-hour rest for partner
                        var partnerRestCheck = check8HourRest(partnerLine, dateKey, myShift);
                        
                        if (partnerBusy) {
                            content += '<div class="swap-option" style="opacity:0.5; cursor:not-allowed; pointer-events:none;">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info" style="color:#e94560;">‚ö† Partner already has a swap on this date</span>';
                            content += '</div>';
                            content += '<span class="action-label" style="background:#888; color:#ccc;">BUSY</span>';
                            content += '</div>';
                        } else if (!partnerRestCheck.valid) {
                            content += '<div class="swap-option" style="opacity:0.5; cursor:not-allowed; pointer-events:none;">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info" style="color:#e94560;">‚ö† 8hr rest violation: ' + partnerRestCheck.reason + '</span>';
                            content += '</div>';
                            content += '<span class="action-label" style="background:#888; color:#ccc;">REST</span>';
                            content += '</div>';
                        } else {
                            content += '<div class="swap-option give" onclick="createSwap(\'' + dateKey + '\', \'' + myLine + '\', \'' + partnerLine + '\', \'' + myShift + '\')">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Give to Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info">Give your ' + myShift + ' shift, partner is OFF</span>';
                            content += '</div>';
                            content += '<span class="action-label">GIVE SHIFT</span>';
                            content += '</div>';
                        }
                    } else if (!myIsWorking && partnerIsWorking) {
                        // I can take partner's shift - check 8-hour rest for me
                        var myRestCheck = check8HourRest(myLine, dateKey, partnerShift);
                        
                        if (partnerBusy) {
                            content += '<div class="swap-option" style="opacity:0.5; cursor:not-allowed; pointer-events:none;">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info" style="color:#e94560;">‚ö† Partner already has a swap on this date</span>';
                            content += '</div>';
                            content += '<span class="action-label" style="background:#888; color:#ccc;">BUSY</span>';
                            content += '</div>';
                        } else if (!myRestCheck.valid) {
                            content += '<div class="swap-option" style="opacity:0.5; cursor:not-allowed; pointer-events:none;">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info" style="color:#e94560;">‚ö† 8hr rest violation: ' + myRestCheck.reason + '</span>';
                            content += '</div>';
                            content += '<span class="action-label" style="background:#888; color:#ccc;">REST</span>';
                            content += '</div>';
                        } else {
                            content += '<div class="swap-option take" onclick="createSwap(\'' + dateKey + '\', \'' + partnerLine + '\', \'' + myLine + '\', \'' + partnerShift + '\')">';
                            content += '<div class="partner-info">';
                            content += '<span class="line-name">Take from Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                            content += '<span class="shift-info">Take their ' + partnerShift + ' shift, you are OFF</span>';
                            content += '</div>';
                            content += '<span class="action-label">TAKE SHIFT</span>';
                            content += '</div>';
                        }
                    } else {
                        // Both working or both off - can't swap
                        content += '<div class="swap-option" style="opacity:0.5; cursor:not-allowed; pointer-events:none;">';
                        content += '<div class="partner-info">';
                        content += '<span class="line-name">Line ' + partnerLine + ' (' + lineData.lineDesc + ')</span>';
                        content += '<span class="shift-info">' + (myIsWorking ? 'Both working - cannot swap' : 'Both off - cannot swap') + '</span>';
                        content += '</div>';
                        content += '<span class="action-label" style="background:#888; color:#ccc;">N/A</span>';
                        content += '</div>';
                    }
                });
            }
            
            if (!content) {
                content = '<p style="color:#888;">No swap options available for this day with your current partners.</p>';
            }
            
            document.getElementById('swapModalContent').innerHTML = content;
            document.getElementById('swapModal').classList.add('show');
        }
        
        function hideSwapModal() {
            document.getElementById('swapModal').classList.remove('show');
        }
        
        function createSwap(dateKey, fromLine, toLine, shift) {
            // Check if swap already exists for this date
            for (var i = 0; i < swaps.length; i++) {
                if (swaps[i].date === dateKey && (swaps[i].fromLine === myLine || swaps[i].toLine === myLine)) {
                    alert('You already have a swap on this date');
                    return;
                }
            }
            
            swaps.push({
                date: dateKey,
                fromLine: fromLine,
                toLine: toLine,
                shift: shift
            });
            
            hideSwapModal();
            renderCalendar();
            if (currentView === 'allLines') renderAllLinesView();
            updateStats();
            updatePartnerBalances();
            autoSave();
        }
        
        function removeSwap(dateKey) {
            swaps = swaps.filter(function(s) {
                return s.date !== dateKey;
            });
            
            hideSwapModal();
            renderCalendar();
            if (currentView === 'allLines') renderAllLinesView();
            updateStats();
            updatePartnerBalances();
            autoSave();
        }
        
        function updateStats() {
            if (!myLine) return;
            
            var calendar = ALL_LINES_CALENDAR[myLine];
            if (!calendar) return;
            
            // Count base work days
            var baseWorkDays = 0;
            for (var dateKey in calendar.days) {
                if (calendar.days[dateKey].s !== '--') {
                    baseWorkDays++;
                }
            }
            
            // Count swaps in and out
            var swapsIn = 0;
            var swapsOut = 0;
            swaps.forEach(function(swap) {
                if (swap.toLine === myLine) swapsIn++;
                if (swap.fromLine === myLine) swapsOut++;
            });
            
            var currentWorkDays = baseWorkDays + swapsIn - swapsOut;
            
            // Update display
            document.getElementById('baseWorkDays').querySelector('.value').textContent = baseWorkDays;
            document.getElementById('currentWorkDays').querySelector('.value').textContent = currentWorkDays;
            document.getElementById('swapsIn').querySelector('.value').textContent = swapsIn;
            document.getElementById('swapsOut').querySelector('.value').textContent = swapsOut;
            
            // Update current work days color
            var currentBox = document.getElementById('currentWorkDays');
            currentBox.className = 'stat-box';
            if (currentWorkDays === 152) {
                currentBox.classList.add('balanced');
            } else if (currentWorkDays > 152) {
                currentBox.classList.add('over');
            } else {
                currentBox.classList.add('under');
            }
            
            // Update balance indicator
            var indicator = document.getElementById('balanceIndicator');
            indicator.style.display = 'block';
            indicator.className = 'balance-indicator';
            
            if (currentWorkDays === 152) {
                indicator.classList.add('balanced');
                indicator.textContent = '‚úì BALANCED (152 days)';
            } else if (currentWorkDays > 152) {
                indicator.classList.add('over');
                indicator.textContent = '‚ö† OVER by ' + (currentWorkDays - 152) + ' day' + (currentWorkDays - 152 > 1 ? 's' : '') + ' (' + currentWorkDays + ' total)';
            } else {
                indicator.classList.add('under');
                indicator.textContent = '‚ö† UNDER by ' + (152 - currentWorkDays) + ' day' + (152 - currentWorkDays > 1 ? 's' : '') + ' (' + currentWorkDays + ' total)';
            }
        }
        
        function updatePartnerBalances() {
            var container = document.getElementById('partnerBalances');
            
            if (partners.length === 0) {
                container.innerHTML = '<p style="color:#888; font-size:12px;">Add partners to see their balances</p>';
                return;
            }
            
            var html = '';
            partners.forEach(function(lineNbr) {
                var calendar = ALL_LINES_CALENDAR[lineNbr];
                if (!calendar) return;
                
                var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === lineNbr; });
                
                // Count base work days
                var baseWorkDays = 0;
                for (var dateKey in calendar.days) {
                    if (calendar.days[dateKey].s !== '--') {
                        baseWorkDays++;
                    }
                }
                
                // Count swaps affecting this partner
                var swapsIn = 0;
                var swapsOut = 0;
                swaps.forEach(function(swap) {
                    if (swap.toLine === lineNbr) swapsIn++;
                    if (swap.fromLine === lineNbr) swapsOut++;
                });
                
                var currentWorkDays = baseWorkDays + swapsIn - swapsOut;
                
                var balanceClass = 'balanced';
                var balanceText = '‚úì ' + currentWorkDays;
                if (currentWorkDays > 152) {
                    balanceClass = 'over';
                    balanceText = '+' + (currentWorkDays - 152) + ' (' + currentWorkDays + ')';
                } else if (currentWorkDays < 152) {
                    balanceClass = 'under';
                    balanceText = '-' + (152 - currentWorkDays) + ' (' + currentWorkDays + ')';
                }
                
                html += '<div class="partner-balance-item">' +
                    '<span class="line-name">Line ' + lineNbr + '</span>' +
                    '<span class="balance ' + balanceClass + '">' + balanceText + '</span>' +
                '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function renderSwapList() {
            var container = document.getElementById('swapListContent');
            
            if (swaps.length === 0) {
                container.innerHTML = '<p style="color:#888;">No swaps yet. Click on days in the calendar to create swaps.</p>';
                return;
            }
            
            // Sort by date
            var sortedSwaps = swaps.slice().sort(function(a, b) {
                return new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/'));
            });
            
            var html = '';
            sortedSwaps.forEach(function(swap) {
                var date = new Date(swap.date.replace(/-/g, '/'));
                var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                var dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                
                var isIncoming = swap.toLine === myLine;
                var otherLine = isIncoming ? swap.fromLine : swap.toLine;
                
                html += '<div class="swap-item">';
                html += '<div class="date">' + dayName + ' ' + dateStr + '</div>';
                html += '<div class="description">' + (isIncoming ? 'Take' : 'Give') + ' ' + swap.shift + '</div>';
                html += '<div class="from-line">' + (isIncoming ? 'From Line ' + otherLine : 'My shift') + '</div>';
                html += '<div class="to-line">' + (isIncoming ? 'To me' : 'To Line ' + otherLine) + '</div>';
                html += '<button class="remove-btn" onclick="removeSwapByDate(\'' + swap.date + '\')">‚úï</button>';
                html += '</div>';
            });
            
            container.innerHTML = html;
        }
        
        function removeSwapByDate(dateKey) {
            swaps = swaps.filter(function(s) {
                return s.date !== dateKey;
            });
            
            renderCalendar();
            if (currentView === 'allLines') renderAllLinesView();
            updateStats();
            updatePartnerBalances();
            autoSave();
        }
        
        function setView(view) {
            currentView = view;
            
            document.getElementById('calViewBtn').classList.toggle('active', view === 'calendar');
            document.getElementById('allLinesViewBtn').classList.toggle('active', view === 'allLines');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
            
            document.getElementById('calendarView').style.display = view === 'calendar' ? 'grid' : 'none';
            document.getElementById('allLinesView').style.display = view === 'allLines' ? 'block' : 'none';
            document.getElementById('listView').style.display = view === 'list' ? 'block' : 'none';
            
            if (view === 'allLines') {
                renderAllLinesView();
            }
        }
        
        function prevMonth() {
            if (currentMonthIndex > 0) {
                currentMonthIndex--;
                renderAllLinesView();
            }
        }
        
        function nextMonth() {
            if (currentMonthIndex < 11) {
                currentMonthIndex++;
                renderAllLinesView();
            }
        }
        
        function renderAllLinesView() {
            if (!myLine) return;
            
            var m = MONTHS[currentMonthIndex];
            document.getElementById('allLinesMonthTitle').textContent = m.name;
            
            var container = document.getElementById('allLinesContent');
            var allLines = [myLine].concat(partners);
            
            // Build day headers
            var firstDay = new Date(m.year, m.month, 1);
            var lastDay = new Date(m.year, m.month + 1, 0);
            var daysInMonth = lastDay.getDate();
            
            var html = '<table style="width:100%; border-collapse:collapse; font-size:11px;">';
            
            // Header row with days
            html += '<thead><tr style="position:sticky; top:0; background:#0f3460; z-index:10;">';
            html += '<th style="padding:8px; text-align:left; color:#4ecca3; min-width:120px; border-bottom:2px solid #16213e;">Line</th>';
            html += '<th style="padding:8px; text-align:center; color:#4ecca3; min-width:50px; border-bottom:2px solid #16213e;">Balance</th>';
            
            for (var d = 1; d <= daysInMonth; d++) {
                var dateKey = m.year + '-' + (m.month + 1) + '-' + d;
                var dayDate = new Date(m.year, m.month, d);
                var dayName = ['Su','Mo','Tu','We','Th','Fr','Sa'][dayDate.getDay()];
                var isWeekend = dayDate.getDay() === 0 || dayDate.getDay() === 6;
                var isHoliday = HOLIDAYS[dateKey];
                
                var headerStyle = 'padding:4px 2px; text-align:center; min-width:32px; border-bottom:2px solid #16213e;';
                if (isHoliday) headerStyle += ' color:#e94560; font-weight:bold;';
                else if (isWeekend) headerStyle += ' color:#888;';
                else headerStyle += ' color:#ccc;';
                
                html += '<th style="' + headerStyle + '">' + d + '<br><span style="font-size:9px;">' + dayName + '</span></th>';
            }
            html += '</tr></thead>';
            
            // Body rows for each line
            html += '<tbody>';
            allLines.forEach(function(lineNbr, idx) {
                var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === lineNbr; });
                var calendar = ALL_LINES_CALENDAR[lineNbr];
                if (!lineData || !calendar) return;
                
                // Calculate balance for this line
                var workDays = getLineWorkDays(lineNbr);
                var balanceClass = workDays === 152 ? 'color:#4ecca3;' : (workDays > 152 ? 'color:#e94560;' : 'color:#f0a500;');
                var balanceText = workDays === 152 ? '‚úì 152' : (workDays > 152 ? '+' + (workDays - 152) : '-' + (152 - workDays));
                
                var isMyLine = lineNbr === myLine;
                var rowBg = isMyLine ? 'background:rgba(78,204,163,0.1);' : (idx % 2 === 0 ? '' : 'background:rgba(255,255,255,0.02);');
                
                html += '<tr style="' + rowBg + '">';
                html += '<td style="padding:8px; color:' + (isMyLine ? '#4ecca3' : '#fff') + '; font-weight:' + (isMyLine ? 'bold' : 'normal') + '; border-bottom:1px solid #16213e;">';
                html += (isMyLine ? '‚òÖ ' : '') + 'Line ' + lineNbr + ' <span style="color:#888;">(' + lineData.lineDesc + ')</span></td>';
                html += '<td style="padding:8px; text-align:center; font-weight:bold; ' + balanceClass + ' border-bottom:1px solid #16213e;">' + balanceText + '</td>';
                
                for (var d = 1; d <= daysInMonth; d++) {
                    var dateKey = m.year + '-' + (m.month + 1) + '-' + d;
                    var effectiveShift = getEffectiveShiftForLine(lineNbr, dateKey);
                    var isWorkDay = effectiveShift !== '--';
                    var isHoliday = HOLIDAYS[dateKey];
                    
                    // Check for swap on this date for this line
                    var swapType = null;
                    for (var s = 0; s < swaps.length; s++) {
                        if (swaps[s].date === dateKey) {
                            if (swaps[s].toLine === lineNbr) swapType = 'in';
                            else if (swaps[s].fromLine === lineNbr) swapType = 'out';
                        }
                    }
                    
                    var cellBg = isWorkDay ? '#FFC000' : '#FFFFFF';
                    var cellColor = '#000';
                    var cellBorder = '';
                    if (swapType === 'in') cellBorder = 'border:2px solid #4ecca3;';
                    else if (swapType === 'out') cellBorder = 'border:2px solid #e94560;';
                    else if (isHoliday) cellBorder = 'border:2px solid #e94560;';
                    
                    var cellStyle = 'padding:2px; text-align:center; background:' + cellBg + '; color:' + cellColor + '; cursor:pointer; font-size:9px; ' + cellBorder;
                    
                    html += '<td style="' + cellStyle + '" onclick="showSwapOptions(\'' + dateKey + '\')" title="' + dateKey + ': ' + effectiveShift + '">';
                    html += (effectiveShift === '--' ? '' : effectiveShift.substring(0,3));
                    html += '</td>';
                }
                
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // Add summary row
            html += '<div style="margin-top:15px; padding:10px; background:#16213e; border-radius:5px; display:flex; gap:20px; flex-wrap:wrap;">';
            allLines.forEach(function(lineNbr) {
                var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === lineNbr; });
                var workDays = getLineWorkDays(lineNbr);
                var isMyLine = lineNbr === myLine;
                var balanceClass = workDays === 152 ? 'color:#4ecca3;' : (workDays > 152 ? 'color:#e94560;' : 'color:#f0a500;');
                var diff = workDays - 152;
                var diffText = diff === 0 ? 'BALANCED' : (diff > 0 ? '+' + diff + ' over' : diff + ' under');
                
                html += '<div style="' + (isMyLine ? 'border:1px solid #4ecca3; padding:5px 10px; border-radius:5px;' : '') + '">';
                html += '<span style="color:' + (isMyLine ? '#4ecca3' : '#888') + ';">' + (isMyLine ? '‚òÖ ' : '') + 'Line ' + lineNbr + ':</span> ';
                html += '<span style="font-weight:bold; ' + balanceClass + '">' + workDays + ' days (' + diffText + ')</span>';
                html += '</div>';
            });
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        function getLineWorkDays(lineNbr) {
            var calendar = ALL_LINES_CALENDAR[lineNbr];
            if (!calendar) return 0;
            
            // Count base work days
            var workDays = 0;
            for (var dateKey in calendar.days) {
                if (calendar.days[dateKey].s !== '--') {
                    workDays++;
                }
            }
            
            // Apply swaps
            swaps.forEach(function(swap) {
                if (swap.toLine === lineNbr) workDays++;
                if (swap.fromLine === lineNbr) workDays--;
            });
            
            return workDays;
        }
        
        function autoSave() {
            try {
                var data = {
                    myLine: myLine,
                    partners: partners,
                    swaps: swaps
                };
                localStorage.setItem('polishBidSwapBuilder', JSON.stringify(data));
            } catch (e) {
                console.error('Error auto-saving:', e);
            }
        }
        
        function saveSwaps() {
            autoSave();
            alert('Swaps saved! Your data will be restored when you return.');
        }
        
        function loadSavedSwaps() {
            try {
                var stored = localStorage.getItem('polishBidSwapBuilder');
                if (stored) {
                    var data = JSON.parse(stored);
                    if (data.myLine) {
                        myLine = data.myLine;
                        document.getElementById('myLineSelect').value = myLine;
                        selectMyLine();
                    }
                    if (data.partners) {
                        partners = data.partners;
                        renderPartnerList();
                    }
                    if (data.swaps) {
                        swaps = data.swaps;
                        renderCalendar();
                        updateStats();
                        updatePartnerBalances();
                    }
                }
            } catch (e) {
                console.error('Error loading saved swaps:', e);
            }
        }
        
        function clearAllSwaps() {
            if (!confirm('Clear all swaps and partners? This cannot be undone.')) return;
            
            // Clear state completely
            swaps.length = 0;  // Clear array in place
            partners.length = 0;  // Clear array in place
            
            // Also reassign to be safe
            swaps = [];
            partners = [];
            
            // Clear localStorage
            try {
                localStorage.removeItem('polishBidSwapBuilder');
            } catch (e) {
                console.error('Error clearing localStorage:', e);
            }
            
            // Re-render all views
            renderPartnerList();
            renderCalendar();
            renderAllLinesView();
            renderSwapList();
            updateStats();
            updatePartnerBalances();
            
            console.log('Cleared - swaps:', swaps.length, 'partners:', partners.length);
        }
        
        function exportSwappedICS() {
            if (!myLine) {
                alert('Please select your line first');
                return;
            }
            
            var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === myLine; });
            var calendar = ALL_LINES_CALENDAR[myLine];
            if (!calendar || !lineData) return;
            
            var icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//Polish Bid Swap Builder//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:Line ' + myLine + ' (' + lineData.lineDesc + ') - Custom Schedule'
            ];
            
            // Generate events for each day
            var startDate = new Date(2026, 3, 1);
            var endDate = new Date(2027, 2, 31);
            var currentDate = new Date(startDate);
            
            while (currentDate <= endDate) {
                var dateKey = currentDate.getFullYear() + '-' + (currentDate.getMonth() + 1) + '-' + currentDate.getDate();
                var effectiveShift = getEffectiveShift(myLine, dateKey);
                
                if (effectiveShift !== '--') {
                    var year = currentDate.getFullYear();
                    var month = String(currentDate.getMonth() + 1).padStart(2, '0');
                    var day = String(currentDate.getDate()).padStart(2, '0');
                    
                    var hour = parseInt(effectiveShift.substring(1, 3), 10);
                    if (isNaN(hour)) hour = 6;
                    var startHour = String(hour).padStart(2, '0');
                    var endHourNum = (hour + 12) % 24;
                    var endHour = String(endHourNum).padStart(2, '0');
                    
                    // Handle overnight shifts - end date is next day
                    var endYear = year;
                    var endMonth = month;
                    var endDay = day;
                    if (hour + 12 >= 24) {
                        var endDate = new Date(currentDate);
                        endDate.setDate(endDate.getDate() + 1);
                        endYear = endDate.getFullYear();
                        endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
                        endDay = String(endDate.getDate()).padStart(2, '0');
                    }
                    
                    var swapInfo = getSwapInfo(dateKey);
                    var description = 'Line ' + myLine;
                    if (swapInfo) {
                        var otherLine = swapInfo.type === 'in' ? swapInfo.swap.fromLine : swapInfo.swap.toLine;
                        description += swapInfo.type === 'in' ? ' (Swapped from Line ' + otherLine + ')' : ' (Swapped to Line ' + otherLine + ')';
                    }
                    
                    icsContent.push('BEGIN:VEVENT');
                    icsContent.push('DTSTART:' + year + month + day + 'T' + startHour + '0000');
                    icsContent.push('DTEND:' + endYear + endMonth + endDay + 'T' + endHour + '0000');
                    icsContent.push('SUMMARY:' + effectiveShift + (swapInfo ? ' *' : ''));
                    icsContent.push('DESCRIPTION:' + description);
                    icsContent.push('UID:' + year + month + day + '-swap-' + myLine + '@polishbid');
                    icsContent.push('END:VEVENT');
                }
                
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            icsContent.push('END:VCALENDAR');
            
            var blob = new Blob([icsContent.join('\r\n')], { type: 'text/calendar' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'Line_' + myLine + '_CustomSchedule_2026-27.ics';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function printSwapSummary() {
            if (!myLine) {
                alert('Please select your line first');
                return;
            }
            
            var lineData = ANNUAL_BID.find(function(l) { return l.lineNbr === myLine; });
            var calendar = ALL_LINES_CALENDAR[myLine];
            if (!calendar || !lineData) return;
            
            // Calculate stats
            var baseWorkDays = 0;
            for (var dateKey in calendar.days) {
                if (calendar.days[dateKey].s !== '--') baseWorkDays++;
            }
            
            var swapsIn = 0, swapsOut = 0;
            swaps.forEach(function(swap) {
                if (swap.toLine === myLine) swapsIn++;
                if (swap.fromLine === myLine) swapsOut++;
            });
            var currentWorkDays = baseWorkDays + swapsIn - swapsOut;
            
            // Sort swaps by date
            var sortedSwaps = swaps.slice().sort(function(a, b) {
                return new Date(a.date.replace(/-/g, '/')) - new Date(b.date.replace(/-/g, '/'));
            });
            
            var html = '<!DOCTYPE html><html><head><title>Swap Summary - Line ' + myLine + '</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }' +
                'h1 { color: #e94560; border-bottom: 2px solid #e94560; padding-bottom: 10px; }' +
                'h2 { color: #4ecca3; margin-top: 25px; }' +
                '.stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }' +
                '.stat-box { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }' +
                '.stat-value { font-size: 24px; font-weight: bold; }' +
                '.stat-label { font-size: 11px; color: #666; margin-top: 5px; }' +
                '.balanced { color: #4ecca3; }' +
                '.over { color: #e94560; }' +
                '.under { color: #f0a500; }' +
                '.swap-table { width: 100%; border-collapse: collapse; margin-top: 15px; }' +
                '.swap-table th, .swap-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }' +
                '.swap-table th { background: #f5f5f5; }' +
                '.take { color: #4ecca3; }' +
                '.give { color: #e94560; }' +
                '@media print { body { padding: 0; } }' +
                '</style></head><body>';
            
            html += '<h1>Swap Summary - Line ' + myLine + ' (' + lineData.lineDesc + ')</h1>';
            
            html += '<div class="stats">';
            html += '<div class="stat-box"><div class="stat-value">' + baseWorkDays + '</div><div class="stat-label">Base Work Days</div></div>';
            html += '<div class="stat-box"><div class="stat-value">+' + swapsIn + '</div><div class="stat-label">Shifts Taken</div></div>';
            html += '<div class="stat-box"><div class="stat-value">-' + swapsOut + '</div><div class="stat-label">Shifts Given</div></div>';
            
            var balanceClass = currentWorkDays === 152 ? 'balanced' : (currentWorkDays > 152 ? 'over' : 'under');
            html += '<div class="stat-box"><div class="stat-value ' + balanceClass + '">' + currentWorkDays + '</div><div class="stat-label">Final Work Days</div></div>';
            html += '</div>';
            
            if (currentWorkDays !== 152) {
                var diff = Math.abs(currentWorkDays - 152);
                html += '<p style="text-align:center; color:' + (currentWorkDays > 152 ? '#e94560' : '#f0a500') + '; font-weight:bold;">' +
                    '‚ö† ' + (currentWorkDays > 152 ? 'OVER' : 'UNDER') + ' by ' + diff + ' day' + (diff > 1 ? 's' : '') + '</p>';
            } else {
                html += '<p style="text-align:center; color:#4ecca3; font-weight:bold;">‚úì BALANCED</p>';
            }
            
            if (sortedSwaps.length > 0) {
                html += '<h2>Swap Details (' + sortedSwaps.length + ' swaps)</h2>';
                html += '<table class="swap-table"><thead><tr><th>Date</th><th>Action</th><th>Shift</th><th>Partner</th></tr></thead><tbody>';
                
                sortedSwaps.forEach(function(swap) {
                    var date = new Date(swap.date.replace(/-/g, '/'));
                    var dateStr = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                    var isIncoming = swap.toLine === myLine;
                    var otherLine = isIncoming ? swap.fromLine : swap.toLine;
                    
                    html += '<tr>' +
                        '<td>' + dateStr + '</td>' +
                        '<td class="' + (isIncoming ? 'take' : 'give') + '">' + (isIncoming ? '‚Üê TAKE' : '‚Üí GIVE') + '</td>' +
                        '<td>' + swap.shift + '</td>' +
                        '<td>Line ' + otherLine + '</td>' +
                    '</tr>';
                });
                
                html += '</tbody></table>';
            }
            
            html += '<h2>Partners</h2><ul>';
            if (partners.length === 0) {
                html += '<li>No partners added</li>';
            } else {
                partners.forEach(function(p) {
                    var pData = ANNUAL_BID.find(function(l) { return l.lineNbr === p; });
                    html += '<li>Line ' + p + (pData ? ' (' + pData.lineDesc + ')' : '') + '</li>';
                });
            }
            html += '</ul>';
            
            html += '<p style="margin-top:30px; color:#888; font-size:11px;">Generated ' + new Date().toLocaleString() + '</p>';
            html += '</body></html>';
            
            var printWindow = window.open('', '_blank');
            printWindow.document.write(html);
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
